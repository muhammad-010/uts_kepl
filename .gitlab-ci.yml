stages:
  - install
  - test
  - deploy

variables:
  COMPOSER_MEMORY_LIMIT: -1

install:
  stage: install
  image: laravelsail/php82-composer:latest
  script:
    - composer install --no-interaction --prefer-dist --no-progress
  artifacts:
    paths:
      - vendor/
    expire_in: 1 week

test:
  stage: test
  image: laravelsail/php82-composer:latest
  dependencies:
    - install
  script:
    # Create .env file with required variables
    - cp .env.example .env
    - echo "APP_KEY=base64:dGVzdGtleWZvcmNpdGVzdGluZzEyMzQ1Njc4OTAxMjM0NTY=" >> .env
    - echo "APP_ENV=testing" >> .env
    - echo "SESSION_DRIVER=array" >> .env
    - echo "CACHE_DRIVER=array" >> .env
    - echo "QUEUE_CONNECTION=sync" >> .env
    # Create SQLite database file
    - mkdir -p database
    - touch database/database.sqlite
    - echo "DB_CONNECTION=sqlite" >> .env
    - echo "DB_DATABASE=${CI_PROJECT_DIR}/database/database.sqlite" >> .env
    # Clear config cache and run migrations
    - php artisan config:clear
    - php artisan migrate --force
    # Run tests
    - php artisan test --colors=always
  artifacts:
    when: always
    paths:
      - storage/logs/
    expire_in: 1 week

# Deploy to Vercel (Frontend)
deploy_vercel:
  stage: deploy
  image: node:18-alpine
  before_script:
    - npm install -g vercel
  script:
    - npm ci
    - npm run build
    - echo "Vercel deployment would happen here"
    - echo "Run 'vercel --prod' with VERCEL_TOKEN to deploy"
  environment:
    name: production-frontend
    url: https://uts-kepl.vercel.app
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual

# Deploy to Render (Full App)
deploy_render:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Render deployment is automatic via GitHub/GitLab webhook"
    - echo "Push to main triggers Render deploy via render.yaml Blueprint"
    - echo "Manual trigger via Render Dashboard if needed"
  environment:
    name: production
    url: https://umkm-inventory.onrender.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual

# Deploy to Heroku (Legacy - Disabled)
deploy_heroku:
  stage: deploy
  image: ruby:latest
  script:
    - echo "Heroku deployment disabled - using Render instead"
  rules:
    - when: never