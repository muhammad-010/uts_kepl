stages:
  - install
  - test
  - build
  - pages

variables:
  PHP_VERSION: "8.2"
  APP_ENV: "testing"
  APP_DEBUG: "true"
  APP_URL: "http://localhost"
  SESSION_DRIVER: "array"
  CACHE_STORE: "array"
  QUEUE_CONNECTION: "sync"
  MAIL_MAILER: "log"
  SANCTUM_STATEFUL_DOMAINS: "localhost"
  DB_CONNECTION: "sqlite"
  DB_DATABASE: "$CI_PROJECT_DIR/database/database.testing.sqlite"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/
    - node_modules/

# INSTALL DEPENDENCIES
install:
  stage: install
  image: laravelsail/php82-composer:latest
  script:
    - php -v
    - composer install --no-interaction --prefer-dist --no-progress
    - npm ci
    - npm run build || true
    - mkdir -p database
    - touch "$DB_DATABASE"
    - |
      if [ -z "$APP_KEY" ]; then
        export APP_KEY="$(php -r "echo 'base64:'.base64_encode(random_bytes(32));")"
        echo "Generated new APP_KEY for CI"
      fi
  artifacts:
    paths:
      - vendor/
      - node_modules/
    expire_in: 1 week

# RUN TESTS
test:
  stage: test
  image: laravelsail/php82-composer:latest
  dependencies:
    - install
  script:
    - php artisan key:generate --force
    - php artisan migrate --force
    - php artisan test --colors=always
  artifacts:
    when: always
    reports:
      junit: storage/test-results/junit.xml
    paths:
      - storage/logs/
    expire_in: 1 week

# BUILD FRONTEND (Vite / Blade)
build:
  stage: build
  image: node:20-alpine
  dependencies:
    - install
  script:
    - npm ci
    - npm run build
    - echo "âœ… Assets built successfully"
  artifacts:
    paths:
      - public/
      - resources/
    expire_in: 1 week

# DEPLOY TO GITLAB PAGES
pages:
  stage: pages
  image: alpine:latest
  dependencies:
    - build
  script:
    - echo "ðŸ”§ Preparing GitLab Pages artifact..."
    - mkdir -p public
    - cp -r ./public/* ./public/
    - cp -r resources/views public/
    - echo "âœ… GitLab Pages content ready."
  artifacts:
    paths:
      - public
  only:
    - main
    - dev
  environment:
    name: pages
    url: https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}